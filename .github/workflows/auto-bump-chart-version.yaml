name: Auto Bump Chart Version

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'charts/**/values.yaml'
      - 'charts/**/templates/**'
      - 'charts/**/Chart.yaml'

jobs:
  bump-version:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6.0.0
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect changed charts and bump versions
        id: bump
        run: |
          set -e
          
          # 変更されたチャートを検出
          CHANGED_CHARTS=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep '^charts/' | cut -d'/' -f2 | sort -u)
          
          if [ -z "$CHANGED_CHARTS" ]; then
            echo "No charts changed"
            echo "charts_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "charts_changed=true" >> $GITHUB_OUTPUT
          BUMPED_CHARTS=""
          
          for CHART in $CHANGED_CHARTS; do
            CHART_YAML="charts/$CHART/Chart.yaml"
            VALUES_YAML="charts/$CHART/values.yaml"
            TEMPLATES_DIR="charts/$CHART/templates"
            
            if [ ! -f "$CHART_YAML" ]; then
              echo "Skipping $CHART (no Chart.yaml found)"
              continue
            fi
            
            echo "Processing chart: $CHART"
            
            # 現在のバージョンを取得
            CURRENT_VERSION=$(grep '^version:' "$CHART_YAML" | awk '{print $2}')
            CURRENT_APP_VERSION=$(grep '^appVersion:' "$CHART_YAML" | sed 's/^appVersion: *["'"'"']*\(.*\)["'"'"']*/\1/')
            echo "Current version: $CURRENT_VERSION"
            echo "Current appVersion: $CURRENT_APP_VERSION"
            
            # ベースブランチのバージョンを取得
            BASE_VERSION=$(git show origin/${{ github.base_ref }}:$CHART_YAML | grep '^version:' | awk '{print $2}' || echo "$CURRENT_VERSION")
            echo "Base version: $BASE_VERSION"
            
            NEEDS_VERSION_BUMP=false
            
            # Chart.yaml以外の変更があるかチェック
            if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -q "^charts/$CHART/" | grep -v "Chart.yaml"; then
              # values.yaml、templates、その他のファイルが変更されている場合
              if [ "$CURRENT_VERSION" = "$BASE_VERSION" ]; then
                echo "Chart files changed but version not bumped - will auto-bump"
                NEEDS_VERSION_BUMP=true
              else
                echo "Version already bumped manually from $BASE_VERSION to $CURRENT_VERSION"
              fi
            fi
            
            # values.yamlのタグが変更されている場合、appVersionも更新
            if git diff origin/${{ github.base_ref }}..HEAD -- "$VALUES_YAML" | grep -q '^\+.*tag:'; then
              # values.yamlのタグからappVersionを更新
              NEW_APP_VERSION=$(grep 'tag:' "$VALUES_YAML" | head -1 | sed 's/.*tag: *["'"'"']*\(.*\)["'"'"']*/\1/')
              echo "New appVersion from tag: $NEW_APP_VERSION"
              
              if [ "$NEW_APP_VERSION" != "$CURRENT_APP_VERSION" ]; then
                echo "Updating appVersion to $NEW_APP_VERSION"
                # appVersionを更新
                sed -i.bak "s/^appVersion: .*/appVersion: \"$NEW_APP_VERSION\"/" "$CHART_YAML"
                rm -f "$CHART_YAML.bak"
                NEEDS_VERSION_BUMP=true
              fi
            fi
            
            # バージョンのbumpが必要な場合のみ実行
            if [ "$NEEDS_VERSION_BUMP" = true ]; then
              # バージョンをパッチバージョンアップ
              NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print $1"."$2"."$3+1}')
              echo "Bumping version: $CURRENT_VERSION -> $NEW_VERSION"
              
              # Chart.yamlのバージョンを更新
              sed -i.bak "s/^version: .*/version: $NEW_VERSION/" "$CHART_YAML"
              rm -f "$CHART_YAML.bak"
              
              BUMPED_CHARTS="$BUMPED_CHARTS $CHART"
            else
              echo "No version bump needed for $CHART"
            fi
          done
          
          echo "bumped_charts=$BUMPED_CHARTS" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.bump.outputs.charts_changed == 'true'
        run: |
          git add charts/*/Chart.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto-bump chart versions for updated charts"
            git push origin ${{ github.head_ref }}
          fi
