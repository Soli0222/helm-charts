{{- if .Values.monitoring.prometheusRule.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "chart.fullname" . }}
  {{- if .Values.monitoring.prometheusRule.namespace }}
  namespace: {{ .Values.monitoring.prometheusRule.namespace }}
  {{- end }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    {{- with .Values.monitoring.prometheusRule.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.monitoring.prometheusRule.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  groups:
    - name: {{ include "chart.fullname" . }}.rules
      rules:
        {{- if .Values.monitoring.prometheusRule.rules.errorRate.enabled }}
        - alert: EmojiRendererHighErrorRate
          expr: |
            (
              sum(rate(render_errors_total{job="{{ include "chart.fullname" . }}"}[5m]))
              /
              sum(rate(render_requests_total{job="{{ include "chart.fullname" . }}"}[5m]))
            ) * 100 > {{ .Values.monitoring.prometheusRule.rules.errorRate.threshold }}
          for: {{ .Values.monitoring.prometheusRule.rules.errorRate.for }}
          labels:
            severity: {{ .Values.monitoring.prometheusRule.rules.errorRate.severity }}
          annotations:
            summary: "High error rate detected in Emoji Renderer"
            description: "Error rate is above {{ .Values.monitoring.prometheusRule.rules.errorRate.threshold }}% for more than {{ .Values.monitoring.prometheusRule.rules.errorRate.for }}"
        {{- end }}
        {{- if .Values.monitoring.prometheusRule.rules.slowRender.enabled }}
        - alert: EmojiRendererSlowRender
          expr: |
            histogram_quantile(0.95, sum(rate(render_duration_seconds_bucket{job="{{ include "chart.fullname" . }}"}[5m])) by (le))
            > {{ .Values.monitoring.prometheusRule.rules.slowRender.threshold }}
          for: {{ .Values.monitoring.prometheusRule.rules.slowRender.for }}
          labels:
            severity: {{ .Values.monitoring.prometheusRule.rules.slowRender.severity }}
          annotations:
            summary: "Slow render times detected in Emoji Renderer"
            description: "95th percentile render time is above {{ .Values.monitoring.prometheusRule.rules.slowRender.threshold }}s for more than {{ .Values.monitoring.prometheusRule.rules.slowRender.for }}"
        {{- end }}
        {{- if .Values.monitoring.prometheusRule.rules.serviceDown.enabled }}
        - alert: EmojiRendererDown
          expr: up{job="{{ include "chart.fullname" . }}"} == 0
          for: {{ .Values.monitoring.prometheusRule.rules.serviceDown.for }}
          labels:
            severity: {{ .Values.monitoring.prometheusRule.rules.serviceDown.severity }}
          annotations:
            summary: "Emoji Renderer is down"
            description: "Emoji Renderer has been down for more than {{ .Values.monitoring.prometheusRule.rules.serviceDown.for }}"
        {{- end }}
        {{- with .Values.monitoring.prometheusRule.additionalRules }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
{{- end }}
