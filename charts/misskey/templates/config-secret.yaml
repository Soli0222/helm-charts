{{- if not .Values.misskey.existingConfigSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "misskey.fullname" . }}-config
  labels:
    {{- include "misskey.labels" . | nindent 4 }}
type: Opaque
stringData:
  default.yml: |
    #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Misskey configuration (generated by Helm)
    #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    {{- if .Values.misskey.publishTarballInsteadOfProvideRepositoryUrl }}
    #   ┌────────────────────────────────────────┐
    #───┘ Source code publication (AGPL compliance) └───────────────
    publishTarballInsteadOfProvideRepositoryUrl: true
    {{- end }}

    {{- if .Values.misskey.setupPassword }}
    #   ┌────────────────────────┐
    #───┘ Initial Setup Password └──────────────────────────────────
    setupPassword: {{ .Values.misskey.setupPassword | quote }}
    {{- end }}

    #   ┌─────┐
    #───┘ URL └─────────────────────────────────────────────────────
    url: {{ .Values.misskey.url | quote }}

    #   ┌───────────────────────┐
    #───┘ Port and TLS settings └───────────────────────────────────
    port: {{ .Values.misskey.port }}

    {{- if .Values.misskey.socket }}
    socket: {{ .Values.misskey.socket | quote }}
    {{- end }}
    {{- if .Values.misskey.chmodSocket }}
    chmodSocket: {{ .Values.misskey.chmodSocket | quote }}
    {{- end }}

    {{- if .Values.misskey.disableHsts }}
    disableHsts: true
    {{- end }}

    #   ┌───────────────────────────────────────────────┐
    #───┘ Trust proxy (for deployment behind a proxy) └─────────────
    {{- if .Values.misskey.trustProxy }}
    {{- if kindIs "bool" .Values.misskey.trustProxy }}
    trustProxy: {{ .Values.misskey.trustProxy }}
    {{- else if kindIs "slice" .Values.misskey.trustProxy }}
    trustProxy:
      {{- toYaml .Values.misskey.trustProxy | nindent 6 }}
    {{- else }}
    trustProxy: {{ .Values.misskey.trustProxy }}
    {{- end }}
    {{- end }}

    #   ┌──────────────────────────┐
    #───┘ PostgreSQL configuration └────────────────────────────────
    db:
      host: {{ include "misskey.postgresql.host" . }}
      port: {{ include "misskey.postgresql.port" . }}
      db: {{ include "misskey.postgresql.database" . }}
      user: {{ include "misskey.postgresql.username" . }}
      # password is provided via DATABASE_URL environment variable
      {{- if .Values.postgresql.enabled }}
      {{- if .Values.postgresql.disableCache }}
      disableCache: true
      {{- end }}
      {{- if .Values.postgresql.extra }}
      extra:
        {{- toYaml .Values.postgresql.extra | nindent 8 }}
      {{- end }}
      {{- else }}
      {{- if .Values.externalPostgresql.ssl }}
      extra:
        ssl: true
      {{- else if .Values.externalPostgresql.extra }}
      extra:
        {{- toYaml .Values.externalPostgresql.extra | nindent 8 }}
      {{- end }}
      {{- end }}

    {{- if and .Values.postgresql.enabled .Values.postgresql.replication.enabled }}
    dbReplications: true
    dbSlaves:
      {{- range $index, $slave := .Values.postgresql.replication.slaves }}
      - host: {{ $slave.host }}
        port: {{ $slave.port }}
        db: {{ $slave.db }}
        user: {{ $slave.user }}
        {{- if $slave.existingSecret }}
        {{- $slaveSecret := lookup "v1" "Secret" $.Release.Namespace $slave.existingSecret }}
        {{- if $slaveSecret }}
        pass: {{ index $slaveSecret.data (default "password" $slave.existingSecretKey) | b64dec | quote }}
        {{- else }}
        pass: {{ $slave.pass | quote }}
        {{- end }}
        {{- else }}
        pass: {{ $slave.pass | quote }}
        {{- end }}
      {{- end }}
    {{- else }}
    dbReplications: false
    {{- end }}

    #   ┌─────────────────────┐
    #───┘ Redis configuration └─────────────────────────────────────
    redis:
      host: {{ include "misskey.redis.host" . }}
      port: {{ include "misskey.redis.port" . }}
      {{- $redisPass := include "misskey.redis.password" . }}
      {{- if $redisPass }}
      pass: {{ $redisPass | quote }}
      {{- end }}
      {{- if .Values.redis.enabled }}
      {{- if .Values.redis.family }}
      family: {{ .Values.redis.family }}
      {{- end }}
      {{- if .Values.redis.prefix }}
      prefix: {{ .Values.redis.prefix | quote }}
      {{- end }}
      {{- if .Values.redis.db }}
      db: {{ .Values.redis.db }}
      {{- end }}
      {{- else }}
      {{- if .Values.externalRedis.family }}
      family: {{ .Values.externalRedis.family }}
      {{- end }}
      {{- if .Values.externalRedis.prefix }}
      prefix: {{ .Values.externalRedis.prefix | quote }}
      {{- end }}
      {{- if .Values.externalRedis.db }}
      db: {{ .Values.externalRedis.db }}
      {{- end }}
      {{- end }}

    {{- if .Values.redisForPubsub.enabled }}
    redisForPubsub:
      host: {{ .Values.redisForPubsub.host }}
      port: {{ .Values.redisForPubsub.port }}
      {{- if .Values.redisForPubsub.family }}
      family: {{ .Values.redisForPubsub.family }}
      {{- end }}
      {{- $pubsubPass := include "misskey.redisForPubsub.password" . }}
      {{- if $pubsubPass }}
      pass: {{ $pubsubPass | quote }}
      {{- end }}
      {{- if .Values.redisForPubsub.prefix }}
      prefix: {{ .Values.redisForPubsub.prefix | quote }}
      {{- end }}
      {{- if .Values.redisForPubsub.db }}
      db: {{ .Values.redisForPubsub.db }}
      {{- end }}
    {{- end }}

    {{- if .Values.redisForJobQueue.enabled }}
    redisForJobQueue:
      host: {{ .Values.redisForJobQueue.host }}
      port: {{ .Values.redisForJobQueue.port }}
      {{- if .Values.redisForJobQueue.family }}
      family: {{ .Values.redisForJobQueue.family }}
      {{- end }}
      {{- $jobqueuePass := include "misskey.redisForJobQueue.password" . }}
      {{- if $jobqueuePass }}
      pass: {{ $jobqueuePass | quote }}
      {{- end }}
      {{- if .Values.redisForJobQueue.prefix }}
      prefix: {{ .Values.redisForJobQueue.prefix | quote }}
      {{- end }}
      {{- if .Values.redisForJobQueue.db }}
      db: {{ .Values.redisForJobQueue.db }}
      {{- end }}
    {{- end }}

    {{- if .Values.redisForTimelines.enabled }}
    redisForTimelines:
      host: {{ .Values.redisForTimelines.host }}
      port: {{ .Values.redisForTimelines.port }}
      {{- if .Values.redisForTimelines.family }}
      family: {{ .Values.redisForTimelines.family }}
      {{- end }}
      {{- $timelinesPass := include "misskey.redisForTimelines.password" . }}
      {{- if $timelinesPass }}
      pass: {{ $timelinesPass | quote }}
      {{- end }}
      {{- if .Values.redisForTimelines.prefix }}
      prefix: {{ .Values.redisForTimelines.prefix | quote }}
      {{- end }}
      {{- if .Values.redisForTimelines.db }}
      db: {{ .Values.redisForTimelines.db }}
      {{- end }}
    {{- end }}

    {{- if .Values.redisForReactions.enabled }}
    redisForReactions:
      host: {{ .Values.redisForReactions.host }}
      port: {{ .Values.redisForReactions.port }}
      {{- if .Values.redisForReactions.family }}
      family: {{ .Values.redisForReactions.family }}
      {{- end }}
      {{- $reactionsPass := include "misskey.redisForReactions.password" . }}
      {{- if $reactionsPass }}
      pass: {{ $reactionsPass | quote }}
      {{- end }}
      {{- if .Values.redisForReactions.prefix }}
      prefix: {{ .Values.redisForReactions.prefix | quote }}
      {{- end }}
      {{- if .Values.redisForReactions.db }}
      db: {{ .Values.redisForReactions.db }}
      {{- end }}
    {{- end }}

    #   ┌───────────────────────────────────┐
    #───┘ Fulltext search configuration └───────────────────────────
    fulltextSearch:
      provider: {{ .Values.misskey.fulltextSearch.provider }}

    {{- if .Values.misskey.meilisearch.enabled }}
    meilisearch:
      host: {{ .Values.misskey.meilisearch.host }}
      port: {{ .Values.misskey.meilisearch.port }}
      apiKey: {{ .Values.misskey.meilisearch.apiKey | quote }}
      ssl: {{ .Values.misskey.meilisearch.ssl }}
      index: {{ .Values.misskey.meilisearch.index | quote }}
      scope: {{ .Values.misskey.meilisearch.scope }}
    {{- end }}

    #   ┌───────────────┐
    #───┘ ID generation └───────────────────────────────────────────
    id: {{ .Values.misskey.id | quote }}

    #   ┌────────────────┐
    #───┘ Error tracking └──────────────────────────────────────────
    {{- if .Values.misskey.sentry.backend.enabled }}
    sentryForBackend:
      enableNodeProfiling: {{ .Values.misskey.sentry.backend.enableNodeProfiling }}
      options:
        dsn: {{ .Values.misskey.sentry.backend.dsn | quote }}
    {{- end }}

    {{- if .Values.misskey.sentry.frontend.enabled }}
    sentryForFrontend:
      options:
        dsn: {{ .Values.misskey.sentry.frontend.dsn | quote }}
    {{- end }}

    #   ┌─────────────────────┐
    #───┘ Other configuration └─────────────────────────────────────

    {{- if .Values.misskey.clusterLimit }}
    clusterLimit: {{ .Values.misskey.clusterLimit }}
    {{- end }}

    {{- if .Values.misskey.deliverJobConcurrency }}
    deliverJobConcurrency: {{ .Values.misskey.deliverJobConcurrency }}
    {{- end }}
    {{- if .Values.misskey.inboxJobConcurrency }}
    inboxJobConcurrency: {{ .Values.misskey.inboxJobConcurrency }}
    {{- end }}
    {{- if .Values.misskey.relationshipJobConcurrency }}
    relationshipJobConcurrency: {{ .Values.misskey.relationshipJobConcurrency }}
    {{- end }}

    {{- if .Values.misskey.deliverJobPerSec }}
    deliverJobPerSec: {{ .Values.misskey.deliverJobPerSec }}
    {{- end }}
    {{- if .Values.misskey.inboxJobPerSec }}
    inboxJobPerSec: {{ .Values.misskey.inboxJobPerSec }}
    {{- end }}
    {{- if .Values.misskey.relationshipJobPerSec }}
    relationshipJobPerSec: {{ .Values.misskey.relationshipJobPerSec }}
    {{- end }}

    {{- if .Values.misskey.deliverJobMaxAttempts }}
    deliverJobMaxAttempts: {{ .Values.misskey.deliverJobMaxAttempts }}
    {{- end }}
    {{- if .Values.misskey.inboxJobMaxAttempts }}
    inboxJobMaxAttempts: {{ .Values.misskey.inboxJobMaxAttempts }}
    {{- end }}

    {{- if .Values.misskey.outgoingAddress }}
    outgoingAddress: {{ .Values.misskey.outgoingAddress | quote }}
    {{- end }}
    {{- if .Values.misskey.outgoingAddressFamily }}
    outgoingAddressFamily: {{ .Values.misskey.outgoingAddressFamily }}
    {{- end }}

    {{- if .Values.misskey.proxy }}
    proxy: {{ .Values.misskey.proxy | quote }}
    {{- end }}

    {{- if .Values.misskey.proxyBypassHosts }}
    proxyBypassHosts:
      {{- toYaml .Values.misskey.proxyBypassHosts | nindent 6 }}
    {{- end }}

    {{- if .Values.misskey.proxySmtp }}
    proxySmtp: {{ .Values.misskey.proxySmtp | quote }}
    {{- end }}

    {{- if .Values.misskey.mediaProxy }}
    mediaProxy: {{ .Values.misskey.mediaProxy | quote }}
    {{- end }}

    {{- if .Values.misskey.videoThumbnailGenerator }}
    videoThumbnailGenerator: {{ .Values.misskey.videoThumbnailGenerator | quote }}
    {{- end }}

    {{- if .Values.misskey.allowedPrivateNetworks }}
    allowedPrivateNetworks:
      {{- toYaml .Values.misskey.allowedPrivateNetworks | nindent 6 }}
    {{- end }}

    maxFileSize: {{ .Values.misskey.maxFileSize }}

    {{- if .Values.misskey.pidFile }}
    pidFile: {{ .Values.misskey.pidFile | quote }}
    {{- end }}

    {{- if or .Values.misskey.logging.sql.enableQueryParamLogging .Values.misskey.logging.sql.disableQueryTruncation }}
    logging:
      sql:
        {{- if .Values.misskey.logging.sql.enableQueryParamLogging }}
        enableQueryParamLogging: true
        {{- end }}
        {{- if .Values.misskey.logging.sql.disableQueryTruncation }}
        disableQueryTruncation: true
        {{- end }}
    {{- end }}
{{- end }}